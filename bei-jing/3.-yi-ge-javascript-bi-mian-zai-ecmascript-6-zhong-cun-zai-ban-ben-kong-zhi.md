# 3. 一个 JavaScript：避免在 ECMAScript 6 中存在版本控制

### 3.1 版本控制

原则上，语言的新版本是清理它的机会，通过删除过时的功能或改变功能的工作方式。这意味着新代码在语言的旧实现中不起作用，而旧代码在新实现中不起作用。每段代码都链接到该语言的特定版本。处理不同版本的方法通常有两种。

第一种，可以采取“全有或全无”的方法，要求如果代码库要使用新版本，则必须对其进行全面升级。Python 在从 Python 2 升级到 Python 3 时采用了这种方法。它的一个问题是一次迁移所有现有代码库可能不可行，尤其是在它很大的情况下。此外，这种方法不适用于网络，因为在网络上您将始终拥有旧代码并且 JavaScript 引擎会自动更新。

第二种，可以通过使用版本标记代码来允许代码库包含多个版本的代码。Web 上，您可以通过专用的[网络 媒体类型](https://en.wikipedia.org/wiki/Media\_type)标记 ECMAScript 6 代码。

```
Content-Type: application/ecmascript;version=6
```

也可以通过 `<script>` 元素的 `type` 属性关联（默认值为 text/javascript）：

```html
<script type="application/ecmascript;version=6">
    ···
</script>
```

它指定了与实际内容之外的 out of band 版本。另一个方法可以在内容内指定（in-band）。比如：在文件中用下面这行开头：

```
use version 6;
```

两种标记方式都有问题：out-of-band 版本很脆弱并且可能会丢失，in-band版本会使代码变得混乱。

根本问题是，在代码库中允许多语言，会让一种语言变成必须并行维护的子语言。会造成一些问题：

* 引擎会变得臃肿，因为它们需要实现所有版本的语义功能。这同样适用于分析语言的工具（比如像 JSLint 这类的风格检查器）
* 程序员需要记住版本有何不同
* 代码变得更难重构，因为在移动代码片段的时候需要考虑版本。

因此，要避免版本控制，尤其对于JavaScript 和 Web。

#### 3.1.1 无版本的发展

但我们如何摆脱版本控制？通过始终向后兼容。这就意味着，谈到清理 JavaScript 的时候，需要放弃一些野心。我们不能引入重大的变化。

### 3.2 严格模式和ECMAScript 6

ECMAScript5 中引入了严格模式来清理语言。把下面这行放在文件或者函数的第一行来切换：

```
'use strict';
```

严格模式引入了三种重大的变化：

* 语法变化：一些之前合法的语法在严格模式下被禁止。比如：
  * 禁止使用 with 语句。它允许用户将任意对象添加到变量作用域中，这样会减慢执行速度并且弄清变量所指的内容变得棘手。
  * 禁止删除不合格的标志符（变量，不是属性）
  * 函数只能在作用域的顶层声明。
  * 保留了更多的标识符：implements interface let package private protected public static yield
* 更多的错误。比如：
  * 分配给未声明的变量会导致 ReferenceError。在非严格模式下，这种情况会创建一个全局变量。
  * 更改只读属性（例如字符串长度）会导致 TypeError。在非严格模式下，它根本没有作用。
* 不同语义：一些结构在严格模式下表现不同。例如：
  * arguments 不再跟踪参数的当前值。
  * this 在非方法函数中是 undefined。在非严格模式下，它指的是全局对象（window），意味着如果你不用 new 调用构造函数，就会创建全局变量。

严格模式是版本控制为何棘手的一个很好的例子：尽管它支持更简洁的 JavaScript 版本，但是它的采用率仍然相对较低。主要原因是它破坏了一些现有代码，会减慢执行速度，并且很难添加到文件中（更不用说交互式命令行了）。我喜欢严格模式的理念，但是几乎不经常用。

#### 3.2.1 支持sloppy（非严格）模式

一个JavaScript意味着我们不能放弃sloppy模式：它会继续存在（比如在HTML属性中）。因此，我们不能在严格模式之上构建 ECMAScript6，我们必须将它的特性添加到严格模式和非严格模式（又名sloppy模式）中。否则，严格模式会成为语言的不同版本，我们又回到版本控制了。不幸的是，有两个 ECMAScript 6 特性很难添加到 sloppy 模式中：let 声明和块级函数声明。我们来看看为什么会这样，以及如何添加它们。下面两条语句是合法的 ES5 sloppy 模式：

#### 3.2.2 sloppy模式中的let 声明

let 可以让你声明块级变量。sloppy 模式很难添加，因为 let 只是严格模式下的保留字。

#### 3.2.3 sloppy模式中的块级函数声明

#### 3.2.4 其他关键词

#### 3.2.5 隐含严格模式

### 3.3 ES6 中的重大变化

### 3.4 结论

### 3.5 扩展阅读

\[1] The original 1JS proposal (warning: out of date): “[ES6 doesn’t need opt-in](http://esdiscuss.org/topic/es6-doesn-t-need-opt-in)” by David Herman.
